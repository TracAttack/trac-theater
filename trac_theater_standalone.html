<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trac Theater Reservation System</title>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwcT_wS44m8bPvcBcmZsK_lL1mKlgKCrwCSp03RdfjoAkxGxwk1v8_Do5Nwcg8SEYCd/exec';

    const Film = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M7 3v18M17 3v18M3 7.5h4M3 12h18M3 16.5h4M17 16.5h4"/></svg>;
    const User = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
    const Clock = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>;
    const Utensils = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2M7 2v20M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></svg>;
    const Coffee = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10 2v2M14 2v2M16 8a1 1 0 0 1 1 1v8a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4V9a1 1 0 0 1 1-1h14a4 4 0 1 1 0 8h-1"/></svg>;
    const ChevronRight = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m9 18 6-6-6-6"/></svg>;
    const MessageSquare = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>;
    const Calendar = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>;
    const Edit = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4Z"/></svg>;
    const Trash2 = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>;
    const Plus = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 12h14M12 5v14"/></svg>;
    const Save = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>;
    const X = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6 6 18M6 6l12 12"/></svg>;

    const TheaterApp = () => {
      const [view, setView] = useState('user');
      const [currentUser, setCurrentUser] = useState(null);
      const [loginName, setLoginName] = useState('');
      const [loading, setLoading] = useState(true);
      
      const [movies, setMovies] = useState([]);
      const [persons, setPersons] = useState([]);
      const [foods, setFoods] = useState([]);
      const [drinks, setDrinks] = useState([]);
      const [seats, setSeats] = useState([]);
      const [shows, setShows] = useState([]);
      const [reservations, setReservations] = useState([]);
      const [orders, setOrders] = useState([]);
      const [requests, setRequests] = useState([]);
      
      const [selectedShow, setSelectedShow] = useState(null);
      const [selectedSeat, setSelectedSeat] = useState(null);
      const [selectedFoods, setSelectedFoods] = useState({});
      const [selectedDrinks, setSelectedDrinks] = useState({});
      const [customFoodRequest, setCustomFoodRequest] = useState('');
      const [customDrinkRequest, setCustomDrinkRequest] = useState('');
      const [hoveredSeat, setHoveredSeat] = useState(null);
      
      const [editingItem, setEditingItem] = useState(null);
      const [editForm, setEditForm] = useState({});

      useEffect(() => {
        loadAllData();
        // Create seats if they don't exist
        const seatIds = ['A1', 'A2', 'A3', 'A4', 'B1', 'B2', 'B3', 'B4'];
        const seatData = seatIds.map(id => ({
          id,
          row: id[0],
          number: parseInt(id[1])
        }));
        setSeats(seatData);
      }, []);

      const loadAllData = async () => {
        setLoading(true);
        try {
          // Use fetch for GET - should work now
          const response = await fetch(`${APPS_SCRIPT_URL}?action=getAll`);
          const data = await response.json();
          
          console.log('Loaded data:', data);
          
          setMovies(data.movies || []);
          setPersons(data.persons || []);
          setFoods(data.foods || []);
          setDrinks(data.drinks || []);
          setShows(data.shows || []);
          setReservations(data.reservations || []);
          setOrders(data.orders || []);
          setRequests(data.requests || []);
        } catch (error) {
          console.error('Error loading data:', error);
          alert('Error loading data. Make sure the script is deployed correctly.');
        }
        setLoading(false);
      };

      const appendToSheet = async (sheetName, data) => {
        const response = await fetch(`${APPS_SCRIPT_URL}?action=add&table=${sheetName}&data=${encodeURIComponent(JSON.stringify(data))}`);
        return response.json();
      };

      const updateSheet = async (sheetName, data) => {
        const response = await fetch(`${APPS_SCRIPT_URL}?action=update&table=${sheetName}&data=${encodeURIComponent(JSON.stringify(data))}`);
        return response.json();
      };

      const deleteFromSheet = async (sheetName, id) => {
        const response = await fetch(`${APPS_SCRIPT_URL}?action=delete&table=${sheetName}&data=${encodeURIComponent(JSON.stringify({ id }))}`);
        return response.json();
      };

      const handleLogin = () => {
        const person = persons.find(p => 
          `${p.firstName} ${p.lastName}`.toLowerCase() === loginName.toLowerCase()
        );
        if (person) {
          setCurrentUser(person);
        } else {
          alert('Person not found. Please check the name.');
        }
      };

      const handleAdd = (type) => {
        setEditingItem({ type, isNew: true });
        setEditForm({});
      };

      const handleEdit = (type, item) => {
        setEditingItem({ type, isNew: false });
        setEditForm(item);
      };

      const handleSave = async () => {
        const { type, isNew } = editingItem;
        const tableMap = {
          movie: 'movies',
          person: 'persons',
          food: 'foodItems',
          drink: 'drinkItems',
          show: 'shows'
        };
        
        try {
          if (type === 'person') {
            editForm.initials = `${editForm.firstName?.[0] || ''}${editForm.lastName?.[0] || ''}`;
          }
          
          if (isNew) {
            await appendToSheet(tableMap[type], editForm);
          } else {
            await updateSheet(tableMap[type], editForm);
          }
          await loadAllData();
          setEditingItem(null);
          setEditForm({});
          alert('Saved successfully!');
        } catch (error) {
          console.error('Error saving:', error);
          alert('Error saving data');
        }
      };

      const handleDelete = async (type, id) => {
        if (!confirm('Are you sure you want to delete this item?')) return;
        
        const tableMap = {
          movie: 'movies',
          person: 'persons',
          food: 'foodItems',
          drink: 'drinkItems',
          show: 'shows'
        };
        
        try {
          await deleteFromSheet(tableMap[type], id);
          await loadAllData();
          alert('Deleted successfully!');
        } catch (error) {
          console.error('Error deleting:', error);
          alert('Error deleting data');
        }
      };

      const handleImageUpload = (e, type) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
          if (type === 'movie') {
            setEditForm({ ...editForm, poster: event.target.result });
          } else if (type === 'person') {
            setEditForm({ ...editForm, headshot: event.target.result });
          }
        };
        reader.readAsDataURL(file);
      };

      const getShowsByStatus = () => {
        const now = new Date();
        const categorized = { past: [], current: [], upcoming: [] };
        
        shows.forEach(show => {
          const showDateTime = new Date(`${show.showDate} ${show.showTime}`);
          const movie = movies.find(m => m.id == show.movieId);
          const endTime = new Date(showDateTime.getTime() + (parseInt(movie?.duration) || 120) * 60000);
          
          if (endTime < now) {
            categorized.past.push(show);
          } else if (showDateTime <= now && endTime >= now) {
            categorized.current.push(show);
          } else {
            categorized.upcoming.push(show);
          }
        });
        
        categorized.past.sort((a, b) => new Date(`${b.showDate} ${b.showTime}`) - new Date(`${a.showDate} ${a.showTime}`));
        categorized.current.sort((a, b) => new Date(`${a.showDate} ${a.showTime}`) - new Date(`${b.showDate} ${b.showTime}`));
        categorized.upcoming.sort((a, b) => new Date(`${a.showDate} ${a.showTime}`) - new Date(`${b.showDate} ${b.showTime}`));
        
        return categorized;
      };

      const isSeatReserved = (seatId, showId) => {
        return reservations.some(r => r.showId == showId && r.seatId == seatId);
      };

      const getReservationForSeat = (seatId, showId) => {
        return reservations.find(r => r.showId == showId && r.seatId == seatId);
      };

      const handleReserveSeat = async () => {
        if (!currentUser || !selectedSeat || !selectedShow) return;
        
        const existingReservation = reservations.find(
          r => r.showId == selectedShow.id && r.personId == currentUser.id
        );
        
        if (existingReservation) {
          alert('You already have a reservation for this show.');
          return;
        }
        
        try {
          const reservationData = {
            showId: selectedShow.id,
            seatId: selectedSeat,
            personId: currentUser.id,
            reservedBy: currentUser.id
          };
          
          const reservationResult = await appendToSheet('reservations', reservationData);
          const newReservationId = reservationResult.id;
          
          for (const [foodId, quantity] of Object.entries(selectedFoods)) {
            if (quantity > 0) {
              await appendToSheet('orders', {
                reservationId: newReservationId,
                itemType: 'food',
                itemId: foodId,
                quantity: quantity
              });
            }
          }
          
          for (const [drinkId, quantity] of Object.entries(selectedDrinks)) {
            if (quantity > 0) {
              await appendToSheet('orders', {
                reservationId: newReservationId,
                itemType: 'drink',
                itemId: drinkId,
                quantity: quantity
              });
            }
          }
          
          if (customFoodRequest.trim()) {
            await appendToSheet('requests', {
              reservationId: newReservationId,
              type: 'food',
              request: customFoodRequest.trim()
            });
          }
          
          if (customDrinkRequest.trim()) {
            await appendToSheet('requests', {
              reservationId: newReservationId,
              type: 'drink',
              request: customDrinkRequest.trim()
            });
          }
          
          await loadAllData();
          setSelectedSeat(null);
          setSelectedFoods({});
          setSelectedDrinks({});
          setCustomFoodRequest('');
          setCustomDrinkRequest('');
          alert('Seat reserved successfully!');
        } catch (error) {
          console.error('Error:', error);
          alert('Error saving reservation.');
        }
      };

      useEffect(() => {
        if (selectedShow && currentUser && currentUser.preferredSeatId) {
          const preferredSeat = seats.find(s => s.id == currentUser.preferredSeatId);
          if (preferredSeat && !isSeatReserved(preferredSeat.id, selectedShow.id)) {
            setSelectedSeat(preferredSeat.id);
          }
        }
      }, [selectedShow, currentUser]);

      if (loading) {
        return (
          <div className="min-h-screen bg-gray-900 flex items-center justify-center">
            <div className="text-white text-xl">Loading Trac Theater...</div>
          </div>
        );
      }

      if (!currentUser && view === 'user') {
        return (
          <div className="min-h-screen bg-gray-900 flex items-center justify-center p-4">
            <div className="bg-gray-800 rounded-lg shadow-xl p-8 max-w-md w-full">
              <div className="text-center mb-6">
                <div className="w-16 h-16 text-red-500 mx-auto mb-4 flex items-center justify-center"><Film /></div>
                <h1 className="text-3xl font-bold text-white mb-2">Trac Theater</h1>
                <p className="text-gray-400">Enter your full name to continue</p>
              </div>
              
              <input type="text" placeholder="First Last" value={loginName}
                onChange={(e) => setLoginName(e.target.value)}
                className="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white mb-4"
                onKeyPress={(e) => e.key === 'Enter' && handleLogin()} />
              
              <button onClick={handleLogin}
                className="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-semibold mb-4">
                Login
              </button>
              
              <button onClick={() => setView('admin')}
                className="w-full bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg text-sm">
                Admin Access
              </button>
            </div>
          </div>
        );
      }

      if (view === 'user') {
        const { past, current, upcoming } = getShowsByStatus();
        
        const MovieShowCard = ({ show, movie, status, onSelect, isSelected, readonly }) => {
          if (!movie) return null;
          
          const statusColors = {
            current: 'border-red-500 bg-red-900/20',
            upcoming: 'border-blue-500 bg-blue-900/20',
            past: 'border-gray-600 bg-gray-800/50'
          };
          
          const statusLabels = { current: 'Now Playing', upcoming: 'Upcoming', past: 'Completed' };
          const showDateTime = `${show.showDate} ${show.showTime}`;
          
          return (
            <div className={`border-2 rounded-lg p-4 transition-all ${
                isSelected ? 'border-green-500 bg-green-900/20' : statusColors[status]
              } ${!readonly ? 'cursor-pointer hover:scale-[1.02]' : 'opacity-60'}`}
              onClick={!readonly ? onSelect : undefined}>
              <div className="flex gap-4">
                {movie.poster && <img src={movie.poster} alt={movie.title} className="w-24 h-36 object-cover rounded" />}
                <div className="flex-1">
                  <div className="flex justify-between items-start mb-2">
                    <div>
                      <h3 className="text-xl font-bold">{movie.title}</h3>
                      <p className="text-gray-400">{movie.duration} minutes</p>
                    </div>
                    <span className={`px-3 py-1 rounded-full text-xs font-semibold ${
                      status === 'current' ? 'bg-red-600' : status === 'upcoming' ? 'bg-blue-600' : 'bg-gray-600'
                    }`}>{statusLabels[status]}</span>
                  </div>
                  <div className="flex items-center gap-4 text-sm">
                    <div className="flex items-center gap-1">
                      <Clock />
                      {new Date(showDateTime).toLocaleString()}
                    </div>
                  </div>
                  {!readonly && status !== 'past' && (
                    <div className="mt-3">
                      <button onClick={(e) => { e.stopPropagation(); onSelect(); }}
                        className="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm font-semibold flex items-center gap-2">
                        {status === 'current' ? 'Select Seat' : 'Reserve Seat'}
                        <ChevronRight />
                      </button>
                    </div>
                  )}
                </div>
              </div>
            </div>
          );
        };

        const SeatSelectionPanel = ({ show }) => {
          return (
            <div className="bg-gray-800 rounded-lg p-6 mt-4">
              <h3 className="text-xl font-bold mb-4">Select Your Seat</h3>
              
              <div className="bg-gray-700 h-3 rounded-full mb-8 relative">
                <span className="absolute -top-6 left-1/2 transform -translate-x-1/2 text-sm text-gray-400">SCREEN</span>
              </div>

              <div className="grid grid-cols-4 gap-4 max-w-2xl mx-auto mb-6">
                {seats.map((seat) => {
                  const reservation = getReservationForSeat(seat.id, show.id);
                  const isReserved = !!reservation;
                  const isSelected = selectedSeat == seat.id;
                  const isHovered = hoveredSeat == seat.id;
                  const reservedPerson = isReserved ? persons.find(p => p.id == reservation.personId) : null;
                  const seatOrders = isReserved ? orders.filter(o => o.reservationId == reservation.id) : [];
                  const seatRequests = isReserved ? requests.filter(r => r.reservationId == reservation.id) : [];
                  
                  return (
                    <div key={seat.id} className="relative">
                      <button onClick={() => !isReserved && setSelectedSeat(isSelected ? null : seat.id)}
                        onMouseEnter={() => setHoveredSeat(seat.id)}
                        onMouseLeave={() => setHoveredSeat(null)}
                        disabled={isReserved}
                        className="w-full relative transition-all" style={{ height: '120px' }}>
                        <svg viewBox="0 0 100 120" className="w-full h-full">
                          <rect x="15" y="10" width="70" height="50" rx="8"
                            className={`transition-all ${isReserved ? 'fill-red-800 stroke-red-600' : isSelected ? 'fill-green-600 stroke-green-400' : 'fill-gray-700 stroke-gray-500'}`} strokeWidth="2" />
                          <rect x="10" y="55" width="80" height="40" rx="10"
                            className={`transition-all ${isReserved ? 'fill-red-900 stroke-red-700' : isSelected ? 'fill-green-700 stroke-green-500' : 'fill-gray-800 stroke-gray-600'}`} strokeWidth="2" />
                          <rect x="5" y="60" width="8" height="35" rx="3"
                            className={`transition-all ${isReserved ? 'fill-red-950 stroke-red-800' : isSelected ? 'fill-green-800 stroke-green-600' : 'fill-gray-900 stroke-gray-700'}`} strokeWidth="1.5" />
                          <rect x="87" y="60" width="8" height="35" rx="3"
                            className={`transition-all ${isReserved ? 'fill-red-950 stroke-red-800' : isSelected ? 'fill-green-800 stroke-green-600' : 'fill-gray-900 stroke-gray-700'}`} strokeWidth="1.5" />
                          <rect x="20" y="95" width="6" height="20" rx="2"
                            className={`transition-all ${isReserved ? 'fill-red-950' : isSelected ? 'fill-green-900' : 'fill-gray-900'}`} />
                          <rect x="74" y="95" width="6" height="20" rx="2"
                            className={`transition-all ${isReserved ? 'fill-red-950' : isSelected ? 'fill-green-900' : 'fill-gray-900'}`} />
                          <circle cx="50" cy="45" r="28"
                            className={`transition-all ${isReserved || isSelected ? 'fill-gray-900 stroke-gray-700' : 'fill-gray-800 stroke-gray-600'}`} strokeWidth="2" />
                        </svg>
                        
                        <div className="absolute inset-0 flex items-center justify-center" style={{ top: '-25%' }}>
                          {isReserved && reservedPerson ? (
                            reservedPerson.headshot ? (
                              <div className="relative" style={{ width: '56px', height: '56px' }}>
                                <img src={reservedPerson.headshot} alt="" className="w-full h-full object-cover rounded-full" style={{ clipPath: 'circle(50%)' }} />
                              </div>
                            ) : (
                              <div className="text-sm font-bold text-white">{reservedPerson.initials}</div>
                            )
                          ) : (
                            <div className="text-xs font-bold text-gray-400">{seat.id}</div>
                          )}
                        </div>
                      </button>
                      
                      {isHovered && isReserved && reservedPerson && (
                        <div className="absolute z-10 bg-gray-900 border border-gray-700 rounded-lg p-3 -top-32 left-1/2 transform -translate-x-1/2 whitespace-nowrap shadow-xl">
                          <p className="font-semibold">{reservedPerson.firstName} {reservedPerson.lastName}</p>
                          {seatOrders.map(order => {
                            const item = order.itemType === 'food' ? foods.find(f => f.id == order.itemId) : drinks.find(d => d.id == order.itemId);
                            return item && <p key={order.id} className="text-sm text-gray-400">{item.name} x{order.quantity}</p>;
                          })}
                          {seatRequests.map(req => <p key={req.id} className="text-sm text-blue-400">Custom: {req.request}</p>)}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>

              {selectedSeat && (
                <>
                  <div className="grid md:grid-cols-2 gap-6">
                    <div>
                      <h3 className="font-semibold mb-3 flex items-center gap-2"><Utensils /> Food</h3>
                      <div className="space-y-2 mb-4">
                        {foods.map((food) => (
                          <div key={food.id} className="bg-gray-700 p-3 rounded-lg flex justify-between items-center">
                            <span>{food.name}</span>
                            <div className="flex items-center gap-2">
                              <button onClick={() => setSelectedFoods(p => ({ ...p, [food.id]: Math.max(0, (p[food.id] || 0) - 1) }))}
                                className="w-8 h-8 bg-gray-600 hover:bg-gray-500 rounded">-</button>
                              <span className="w-8 text-center">{selectedFoods[food.id] || 0}</span>
                              <button onClick={() => setSelectedFoods(p => ({ ...p, [food.id]: (p[food.id] || 0) + 1 }))}
                                className="w-8 h-8 bg-gray-600 hover:bg-gray-500 rounded">+</button>
                            </div>
                          </div>
                        ))}
                      </div>
                      <div>
                        <label className="text-sm text-gray-400 mb-2 block">Or request something else:</label>
                        <textarea value={customFoodRequest} onChange={(e) => setCustomFoodRequest(e.target.value)}
                          placeholder="e.g., Gluten-free pretzels..."
                          className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white resize-none" rows="2" />
                      </div>
                    </div>
                    <div>
                      <h3 className="font-semibold mb-3 flex items-center gap-2"><Coffee /> Drink</h3>
                      <div className="space-y-2 mb-4">
                        {drinks.map((drink) => (
                          <div key={drink.id} className="bg-gray-700 p-3 rounded-lg flex justify-between items-center">
                            <span>{drink.name}</span>
                            <div className="flex items-center gap-2">
                              <button onClick={() => setSelectedDrinks(p => ({ ...p, [drink.id]: Math.max(0, (p[drink.id] || 0) - 1) }))}
                                className="w-8 h-8 bg-gray-600 hover:bg-gray-500 rounded">-</button>
                              <span className="w-8 text-center">{selectedDrinks[drink.id] || 0}</span>
                              <button onClick={() => setSelectedDrinks(p => ({ ...p, [drink.id]: (p[drink.id] || 0) + 1 }))}
                                className="w-8 h-8 bg-gray-600 hover:bg-gray-500 rounded">+</button>
                            </div>
                          </div>
                        ))}
                      </div>
                      <div>
                        <label className="text-sm text-gray-400 mb-2 block">Or request something else:</label>
                        <textarea value={customDrinkRequest} onChange={(e) => setCustomDrinkRequest(e.target.value)}
                          placeholder="e.g., Diet root beer..."
                          className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white resize-none" rows="2" />
                      </div>
                    </div>
                  </div>
                  <button onClick={handleReserveSeat}
                    className="mt-6 w-full bg-green-600 hover:bg-green-700 py-3 rounded-lg font-semibold">Reserve Seat</button>
                </>
              )}
            </div>
          );
        };
        
        return (
          <div className="min-h-screen bg-gray-900 text-white p-6">
            <div className="max-w-7xl mx-auto">
              <div className="flex justify-between items-center mb-8">
                <div>
                  <h1 className="text-3xl font-bold mb-1">Welcome, {currentUser.firstName}!</h1>
                  <button onClick={() => setCurrentUser(null)} className="text-gray-400 hover:text-white text-sm">Logout</button>
                </div>
                <button onClick={() => setView('admin')} className="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-sm">Admin View</button>
              </div>

              {current.length > 0 && (
                <div className="mb-8">
                  <h2 className="text-2xl font-bold mb-4 flex items-center gap-2"><Film /> Now Playing</h2>
                  <div className="grid gap-4">
                    {current.map(show => {
                      const movie = movies.find(m => m.id == show.movieId);
                      const isShowSelected = selectedShow?.id == show.id;
                      return (
                        <div key={show.id}>
                          <MovieShowCard show={show} movie={movie} status="current"
                            onSelect={() => setSelectedShow(isShowSelected ? null : show)} isSelected={isShowSelected} />
                          {isShowSelected && <SeatSelectionPanel show={show} />}
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}

              {upcoming.length > 0 && (
                <div className="mb-8">
                  <h2 className="text-2xl font-bold mb-4 flex items-center gap-2"><Clock /> Upcoming Movies</h2>
                  <div className="grid gap-4">
                    {upcoming.map(show => {
                      const movie = movies.find(m => m.id == show.movieId);
                      const isShowSelected = selectedShow?.id == show.id;
                      return (
                        <div key={show.id}>
                          <MovieShowCard show={show} movie={movie} status="upcoming"
                            onSelect={() => setSelectedShow(isShowSelected ? null : show)} isSelected={isShowSelected} />
                          {isShowSelected && <SeatSelectionPanel show={show} />}
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}

              {past.length > 0 && (
                <div className="mb-8">
                  <h2 className="text-2xl font-bold mb-4 flex items-center gap-2"><Calendar /> Past Shows</h2>
                  <div className="grid gap-4">
                    {past.map(show => {
                      const movie = movies.find(m => m.id == show.movieId);
                      return <MovieShowCard key={show.id} show={show} movie={movie} status="past" readonly={true} />;
                    })}
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      }

      if (view === 'admin') {
        const allRequests = requests.map(req => {
          const reservation = reservations.find(r => r.id == req.reservationId);
          const person = persons.find(p => p.id == reservation?.personId);
          const show = shows.find(s => s.id == reservation?.showId);
          const movie = show ? movies.find(m => m.id == show.movieId) : null;
          return { ...req, person, show, movie };
        });

        return (
          <div className="min-h-screen bg-gray-900 text-white p-6">
            <div className="max-w-7xl mx-auto">
              <div className="flex justify-between items-center mb-8">
                <h1 className="text-3xl font-bold">Admin Dashboard</h1>
                <button onClick={() => setView('user')} className="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg">User View</button>
              </div>

              <div className="bg-gray-800 rounded-lg p-6 mb-8">
                <h2 className="text-xl font-bold mb-4 flex items-center gap-2"><MessageSquare /> Custom Food & Drink Requests</h2>
                {allRequests.length > 0 ? (
                  <div className="space-y-3">
                    {allRequests.map((req) => (
                      <div key={req.id} className="bg-gray-700 p-4 rounded-lg">
                        <div className="flex justify-between items-start mb-2">
                          <div>
                            <p className="font-semibold">{req.person?.firstName} {req.person?.lastName}</p>
                            <p className="text-sm text-gray-400">{req.movie?.title} â€¢ {req.show ? `${req.show.showDate} ${req.show.showTime}` : 'Unknown'}</p>
                          </div>
                          <span className={`px-3 py-1 rounded-full text-xs font-semibold ${req.type === 'food' ? 'bg-orange-900 text-orange-300' : 'bg-blue-900 text-blue-300'}`}>{req.type}</span>
                        </div>
                        <p className="text-white bg-gray-800 p-3 rounded">{req.request}</p>
                      </div>
                    ))}
                  </div>
                ) : <p className="text-gray-400">No custom requests yet</p>}
              </div>

              <div className="bg-gray-800 rounded-lg p-6 mb-6">
                <h2 className="text-xl font-bold mb-4">Data from Google Sheets</h2>
                <div className="grid grid-cols-3 gap-4 text-sm">
                  <div className="bg-gray-700 p-3 rounded">Movies: {movies.length}</div>
                  <div className="bg-gray-700 p-3 rounded">Persons: {persons.length}</div>
                  <div className="bg-gray-700 p-3 rounded">Foods: {foods.length}</div>
                  <div className="bg-gray-700 p-3 rounded">Drinks: {drinks.length}</div>
                  <div className="bg-gray-700 p-3 rounded">Shows: {shows.length}</div>
                  <div className="bg-gray-700 p-3 rounded">Reservations: {reservations.length}</div>
                  <div className="bg-gray-700 p-3 rounded">Orders: {orders.length}</div>
                  <div className="bg-gray-700 p-3 rounded">Requests: {requests.length}</div>
                </div>
                <button onClick={loadAllData} className="mt-4 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-white">Refresh</button>
              </div>

              {/* Movies */}
              <div className="bg-gray-800 rounded-lg p-6 mb-6">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold flex items-center gap-2"><Film /> Movies</h2>
                  <button onClick={() => handleAdd('movie')} className="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg flex items-center gap-2 text-white">
                    <Plus /> Add
                  </button>
                </div>
                <div className="space-y-3">
                  {movies.map((movie) => (
                    <div key={movie.id} className="bg-gray-700 p-4 rounded-lg flex justify-between items-center">
                      <div className="flex-1 flex items-center gap-4">
                        {movie.poster && <img src={movie.poster} alt={movie.title} className="w-16 h-24 object-cover rounded" />}
                        <div>
                          <p className="font-semibold">{movie.title}</p>
                          <p className="text-sm text-gray-400">{movie.duration} min</p>
                        </div>
                      </div>
                      <div className="flex gap-2">
                        <button onClick={() => handleEdit('movie', movie)} className="p-2 bg-blue-600 hover:bg-blue-700 rounded-lg"><Edit /></button>
                        <button onClick={() => handleDelete('movie', movie.id)} className="p-2 bg-red-600 hover:bg-red-700 rounded-lg"><Trash2 /></button>
                      </div>
                    </div>
                  ))}
                  {movies.length === 0 && <p className="text-gray-400 text-center py-4">No movies yet</p>}
                </div>
              </div>

              {/* Persons */}
              <div className="bg-gray-800 rounded-lg p-6 mb-6">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold flex items-center gap-2"><User /> Persons</h2>
                  <button onClick={() => handleAdd('person')} className="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg flex items-center gap-2 text-white">
                    <Plus /> Add
                  </button>
                </div>
                <div className="space-y-3">
                  {persons.map((person) => (
                    <div key={person.id} className="bg-gray-700 p-4 rounded-lg flex justify-between items-center">
                      <div className="flex-1 flex items-center gap-3">
                        {person.headshot ? (
                          <img src={person.headshot} alt="" className="w-10 h-10 rounded-full object-cover" />
                        ) : (
                          <div className="w-10 h-10 bg-gray-600 rounded-full flex items-center justify-center font-semibold border-2 border-gray-500">{person.initials}</div>
                        )}
                        <div>
                          <p className="font-semibold">{person.firstName} {person.lastName}</p>
                          {person.preferredSeatId && <p className="text-xs text-gray-400">Preferred: {person.preferredSeatId}</p>}
                        </div>
                      </div>
                      <div className="flex gap-2">
                        <button onClick={() => handleEdit('person', person)} className="p-2 bg-blue-600 hover:bg-blue-700 rounded-lg"><Edit /></button>
                        <button onClick={() => handleDelete('person', person.id)} className="p-2 bg-red-600 hover:bg-red-700 rounded-lg"><Trash2 /></button>
                      </div>
                    </div>
                  ))}
                  {persons.length === 0 && <p className="text-gray-400 text-center py-4">No persons yet</p>}
                </div>
              </div>

              {/* Foods */}
              <div className="bg-gray-800 rounded-lg p-6 mb-6">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold flex items-center gap-2"><Utensils /> Food Items</h2>
                  <button onClick={() => handleAdd('food')} className="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg flex items-center gap-2 text-white">
                    <Plus /> Add
                  </button>
                </div>
                <div className="space-y-3">
                  {foods.map((food) => (
                    <div key={food.id} className="bg-gray-700 p-4 rounded-lg flex justify-between items-center">
                      <p className="font-semibold flex-1">{food.name}</p>
                      <div className="flex gap-2">
                        <button onClick={() => handleEdit('food', food)} className="p-2 bg-blue-600 hover:bg-blue-700 rounded-lg"><Edit /></button>
                        <button onClick={() => handleDelete('food', food.id)} className="p-2 bg-red-600 hover:bg-red-700 rounded-lg"><Trash2 /></button>
                      </div>
                    </div>
                  ))}
                  {foods.length === 0 && <p className="text-gray-400 text-center py-4">No food items yet</p>}
                </div>
              </div>

              {/* Drinks */}
              <div className="bg-gray-800 rounded-lg p-6 mb-6">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold flex items-center gap-2"><Coffee /> Drink Items</h2>
                  <button onClick={() => handleAdd('drink')} className="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg flex items-center gap-2 text-white">
                    <Plus /> Add
                  </button>
                </div>
                <div className="space-y-3">
                  {drinks.map((drink) => (
                    <div key={drink.id} className="bg-gray-700 p-4 rounded-lg flex justify-between items-center">
                      <p className="font-semibold flex-1">{drink.name}</p>
                      <div className="flex gap-2">
                        <button onClick={() => handleEdit('drink', drink)} className="p-2 bg-blue-600 hover:bg-blue-700 rounded-lg"><Edit /></button>
                        <button onClick={() => handleDelete('drink', drink.id)} className="p-2 bg-red-600 hover:bg-red-700 rounded-lg"><Trash2 /></button>
                      </div>
                    </div>
                  ))}
                  {drinks.length === 0 && <p className="text-gray-400 text-center py-4">No drink items yet</p>}
                </div>
              </div>

              {/* Shows */}
              <div className="bg-gray-800 rounded-lg p-6 mb-6">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold flex items-center gap-2"><Calendar /> Show Times</h2>
                  <button onClick={() => handleAdd('show')} className="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg flex items-center gap-2 text-white">
                    <Plus /> Add Show
                  </button>
                </div>
                <div className="space-y-3">
                  {shows.map((show) => {
                    const movie = movies.find(m => m.id == show.movieId);
                    return (
                      <div key={show.id} className="bg-gray-700 p-4 rounded-lg flex justify-between items-center">
                        <div className="flex-1">
                          <p className="font-semibold">{movie?.title || 'Unknown Movie'}</p>
                          <p className="text-sm text-gray-400">{show.showDate} at {show.showTime}</p>
                        </div>
                        <div className="flex gap-2">
                          <button onClick={() => handleEdit('show', show)} className="p-2 bg-blue-600 hover:bg-blue-700 rounded-lg"><Edit /></button>
                          <button onClick={() => handleDelete('show', show.id)} className="p-2 bg-red-600 hover:bg-red-700 rounded-lg"><Trash2 /></button>
                        </div>
                      </div>
                    );
                  })}
                  {shows.length === 0 && <p className="text-gray-400 text-center py-4">No shows yet</p>}
                </div>
              </div>

              {/* Edit Modal */}
              {editingItem && (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
                  <div className="bg-gray-800 rounded-lg p-6 max-w-md w-full">
                    <h3 className="text-xl font-bold mb-4 text-white">
                      {editingItem.isNew ? 'Add' : 'Edit'} {editingItem.type.charAt(0).toUpperCase() + editingItem.type.slice(1)}
                    </h3>
                    <div className="space-y-4 mb-6">
                      {editingItem.type === 'movie' && (
                        <>
                          <input placeholder="Title" value={editForm.title || ''} onChange={(e) => setEditForm({ ...editForm, title: e.target.value })}
                            className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" />
                          <input placeholder="Duration (minutes)" type="number" value={editForm.duration || ''} onChange={(e) => setEditForm({ ...editForm, duration: parseInt(e.target.value) })}
                            className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" />
                          <div>
                            <label className="block text-sm text-gray-400 mb-2">Movie Poster</label>
                            <input type="file" accept="image/*" onChange={(e) => handleImageUpload(e, 'movie')}
                              className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" />
                            {editForm.poster && <img src={editForm.poster} alt="Preview" className="mt-2 w-32 h-48 object-cover rounded" />}
                          </div>
                        </>
                      )}
                      {editingItem.type === 'person' && (
                        <>
                          <input placeholder="First Name" value={editForm.firstName || ''} onChange={(e) => setEditForm({ ...editForm, firstName: e.target.value })}
                            className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" />
                          <input placeholder="Last Name" value={editForm.lastName || ''} onChange={(e) => setEditForm({ ...editForm, lastName: e.target.value })}
                            className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" />
                          <select value={editForm.preferredSeatId || ''} onChange={(e) => setEditForm({ ...editForm, preferredSeatId: e.target.value })}
                            className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                            <option value="">No Preferred Seat</option>
                            {['A1', 'A2', 'A3', 'A4', 'B1', 'B2', 'B3', 'B4'].map(seatId => (
                              <option key={seatId} value={seatId}>{seatId}</option>
                            ))}
                          </select>
                          <div>
                            <label className="block text-sm text-gray-400 mb-2">Headshot</label>
                            <input type="file" accept="image/*" onChange={(e) => handleImageUpload(e, 'person')}
                              className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" />
                            {editForm.headshot && <img src={editForm.headshot} alt="Preview" className="mt-2 w-20 h-20 object-cover rounded-full" />}
                          </div>
                        </>
                      )}
                      {(editingItem.type === 'food' || editingItem.type === 'drink') && (
                        <input placeholder="Name" value={editForm.name || ''} onChange={(e) => setEditForm({ ...editForm, name: e.target.value })}
                          className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" />
                      )}
                      {editingItem.type === 'show' && (
                        <>
                          <select value={editForm.movieId || ''} onChange={(e) => setEditForm({ ...editForm, movieId: e.target.value })}
                            className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                            <option value="">Select Movie</option>
                            {movies.map((movie) => (
                              <option key={movie.id} value={movie.id}>{movie.title}</option>
                            ))}
                          </select>
                          <input placeholder="Show Date" type="date" value={editForm.showDate || ''} 
                            onChange={(e) => setEditForm({ ...editForm, showDate: e.target.value })}
                            className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" />
                          <input placeholder="Show Time" type="time" value={editForm.showTime || ''} 
                            onChange={(e) => setEditForm({ ...editForm, showTime: e.target.value })}
                            className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" />
                        </>
                      )}
                    </div>
                    <div className="flex gap-3">
                      <button onClick={handleSave} className="flex-1 bg-green-600 hover:bg-green-700 py-2 rounded-lg flex items-center justify-center gap-2 text-white">
                        <Save /> Save
                      </button>
                      <button onClick={() => { setEditingItem(null); setEditForm({}); }} className="flex-1 bg-gray-600 hover:bg-gray-700 py-2 rounded-lg flex items-center justify-center gap-2 text-white">
                        <X /> Cancel
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      }

      return null;
    };

    ReactDOM.render(<TheaterApp />, document.getElementById('root'));
  </script>
</body>
</html>